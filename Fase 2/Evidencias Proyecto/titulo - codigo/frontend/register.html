<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Registro</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

    <style>
        .toggle-btn {
            cursor: pointer;
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
        }

        .password-wrapper {
            position: relative;
        }

        .card {
            border-radius: 16px;
        }
    </style>
</head>

<body class="bg-light">

<div class="container d-flex justify-content-center align-items-center" style="min-height: 100vh;">
    <div class="col-12 col-sm-10 col-md-6 col-lg-4">

        <div class="card shadow p-4">
            <h3 class="text-center mb-4">Crear cuenta</h3>

            <form id="registerForm" novalidate>

                <!-- EMAIL -->
                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" id="email">
                    <div class="invalid-feedback">Ingresa un email v√°lido.</div>
                </div>

                <!-- CONTRASE√ëA -->
                <div class="mb-3 password-wrapper">
                    <label class="form-label">Contrase√±a</label>
                    <input type="password" class="form-control" id="password">
                    <span class="toggle-btn" onclick="togglePassword('password')">üëÅÔ∏è</span>
                    <div class="invalid-feedback">La contrase√±a debe tener al menos 6 caracteres.</div>
                </div>

                <!-- REPETIR CONTRASE√ëA -->
                <div class="mb-3 password-wrapper">
                    <label class="form-label">Repetir contrase√±a</label>
                    <input type="password" class="form-control" id="password2">
                    <span class="toggle-btn" onclick="togglePassword('password2')">üëÅÔ∏è</span>
                    <div class="invalid-feedback">Las contrase√±as no coinciden.</div>
                </div>

                <!-- SELECCIONAR ROL -->
                <div class="mb-3">
                    <label class="form-label">Rol</label>
                    <select id="role" class="form-select">
                        <option value="agricultor">Agricultor (Crear proyectos, pools y sensores)</option>
                        <option value="investigador">Investigador (Solo lectura & exportaci√≥n)</option>
                    </select>
                </div>

                <button class="btn btn-primary w-100" type="submit">Registrarse</button>

                <div id="msg" class="mt-3"></div>

            </form>

            <p class="text-center mt-3">
                ¬øYa tienes cuenta?
                <a href="login.html">Inicia sesi√≥n</a>
            </p>

        </div>
    </div>
</div>

<script>
function validateEmail(email) {
    return /^\S+@\S+\.\S+$/.test(email);
}

function togglePassword(id) {
    const input = document.getElementById(id);
    input.type = input.type === "password" ? "text" : "password";
}

document.getElementById("registerForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const email = document.getElementById("email");
    const pass = document.getElementById("password");
    const pass2 = document.getElementById("password2");
    const role = document.getElementById("role").value;

    let isValid = true;

    if (!validateEmail(email.value.trim())) {
        email.classList.add("is-invalid");
        isValid = false;
    } else email.classList.remove("is-invalid");

    if (pass.value.length < 6) {
        pass.classList.add("is-invalid");
        isValid = false;
    } else pass.classList.remove("is-invalid");

    if (pass.value !== pass2.value) {
        pass2.classList.add("is-invalid");
        isValid = false;
    } else pass2.classList.remove("is-invalid");

    if (!isValid) return;

    // ENVIAR REGISTRO AL BACKEND
    const res = await fetch("http://localhost:3000/auth/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            email: email.value.trim(),
            password: pass.value,
            role // üëà Enviamos el rol seleccionado
        })
    });

    const data = await res.json();

    if (res.ok) {
        document.getElementById("msg").innerHTML =
            `<div class="alert alert-success">${data.message}</div>`;

        email.value = "";
        pass.value = "";
        pass2.value = "";

    } else {
        document.getElementById("msg").innerHTML =
            `<div class="alert alert-danger">${data.error}</div>`;
    }
});
</script>

</body>
</html>
