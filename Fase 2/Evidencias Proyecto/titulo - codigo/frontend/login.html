<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Login</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

    <style>
        .toggle-btn {
            cursor: pointer;
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
        }

        .password-wrapper {
            position: relative;
        }

        .card {
            border-radius: 16px;
        }
    </style>
</head>

<body class="bg-light">

<div class="container d-flex justify-content-center align-items-center" style="min-height: 100vh;">
    <div class="col-12 col-sm-10 col-md-6 col-lg-4">
        
        <div class="card shadow p-4">
            <h3 class="text-center mb-4">Iniciar sesi√≥n</h3>

            <form id="loginForm" novalidate>
                
                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" id="email">
                    <div class="invalid-feedback">Ingresa un email v√°lido.</div>
                </div>

                <div class="mb-3 password-wrapper">
                    <label class="form-label">Contrase√±a</label>
                    <input type="password" class="form-control" id="password">
                    <span class="toggle-btn" onclick="togglePassword('password')">üëÅÔ∏è</span>
                    <div class="invalid-feedback">Ingresa tu contrase√±a.</div>
                </div>

                <button class="btn btn-primary w-100" type="submit">Iniciar sesi√≥n</button>

                <div id="msg" class="mt-3"></div>

            </form>

            <div class="text-center mt-3">
                <p class="mb-1">¬øNo tienes cuenta?  
                    <a href="register.html">Reg√≠strate</a>
                </p>
                <p>¬øOlvidaste tu contrase√±a?  
                    <a href="forgot.html">Recuperar Contrase√±a</a>
                </p>
            </div>

        </div>
    </div>
</div>

<script>
// ---------------------------
// Utilidades
// ---------------------------
function validateEmail(email) {
    return /^\S+@\S+\.\S+$/.test(email);
}

function togglePassword(id) {
    const input = document.getElementById(id);
    input.type = input.type === "password" ? "text" : "password";
}

// ---------------------------
// LOGIN
// ---------------------------
document.getElementById("loginForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const emailEl = document.getElementById("email");
    const passEl = document.getElementById("password");

    const email = emailEl.value.trim();
    const password = passEl.value;

    let valid = true;

    if (!validateEmail(email)) {
        emailEl.classList.add("is-invalid");
        valid = false;
    } else emailEl.classList.remove("is-invalid");

    if (password.length === 0) {
        passEl.classList.add("is-invalid");
        valid = false;
    } else passEl.classList.remove("is-invalid");

    if (!valid) return;

    const res = await fetch("http://localhost:3000/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password })
    });

    const data = await res.json();

    if (!res.ok) {
        document.getElementById("msg").innerHTML =
            `<div class="alert alert-danger">${data.error}</div>`;
        return;
    }

    // ---------------------------
    // GUARDAR TOKEN Y ROL
    // ---------------------------
    localStorage.setItem("token", data.token);

    try {
        const payload = JSON.parse(atob(data.token.split(".")[1]));
        localStorage.setItem("role", payload.role);
    } catch (e) {
        console.warn("No se pudo leer el rol del token");
    }

    // Limpiar campos
    emailEl.value = "";
    passEl.value = "";

    // Redirigir
    window.location.href = "dashboard.html";
});
</script>

</body>
</html>
